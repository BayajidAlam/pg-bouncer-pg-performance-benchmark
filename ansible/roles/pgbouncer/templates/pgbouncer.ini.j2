;; PgBouncer Configuration
;; Managed by Ansible

[databases]
{{ db_name }} = host=127.0.0.1 port=5432 dbname={{ db_name }}

[pgbouncer]
;;;
;;; Administrative settings
;;;

logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid

;;;
;;; Connection settings
;;;

listen_addr = 0.0.0.0
listen_port = 6432

unix_socket_dir = /var/run/postgresql

;;;
;;; Authentication settings
;;;

auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;;;
;;; Users allowed to use admin console
;;;

admin_users = {{ db_user }}
stats_users = {{ db_user }}

;;;
;;; Connection pooling
;;;

pool_mode = transaction
max_client_conn = {{ pgbouncer_max_client_conn | default(100) }}
default_pool_size = {{ pgbouncer_default_pool_size | default(20) }}
min_pool_size = {{ pgbouncer_min_pool_size | default(5) }}
reserve_pool_size = {{ pgbouncer_reserve_pool_size | default(5) }}
reserve_pool_timeout = 5
max_db_connections = {{ pgbouncer_max_db_connections | default(50) }}
max_user_connections = {{ pgbouncer_max_user_connections | default(50) }}

;;;
;;; Logging
;;;

log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;;;
;;; Timeouts
;;;

server_idle_timeout = 600
server_lifetime = 3600
server_connect_timeout = 15
query_timeout = 0
query_wait_timeout = 120
client_idle_timeout = 0
client_login_timeout = 60

;;;
;;; Dangerous timeouts
;;;

idle_transaction_timeout = 0

;;;
;;; Low-level tuning options
;;;

pkt_buf = 4096
listen_backlog = 128
sbuf_loopcnt = 5
max_packet_size = 2147483647

;;;
;;; Startup parameters
;;;

ignore_startup_parameters = extra_float_digits

;;;
;;; Console access control
;;;

# Only allow admin console from localhost
admin_users = {{ db_user }}
