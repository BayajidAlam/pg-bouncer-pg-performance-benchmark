---
- name: Install Docker dependencies
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: true

- name: Install Docker
  apt:
    name:
      - docker.io
      - docker-compose
    state: present
    update_cache: true

- name: Ensure Docker is enabled and started
  systemd:
    name: docker
    state: started
    enabled: true

- name: Add user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: true

- name: Reset SSH connection to apply group changes
  meta: reset_connection

- name: Create monitoring directory
  file:
    path: /home/{{ ansible_user }}/monitoring
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Create Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: /home/{{ ansible_user }}/monitoring/prometheus.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: Create docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: /home/{{ ansible_user }}/monitoring/docker-compose.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: Start Prometheus and Grafana containers
  shell: cd /home/{{ ansible_user }}/monitoring && docker-compose up -d
  args:
    executable: /bin/bash
  become: true

- name: Wait for Prometheus to be ready
  wait_for:
    port: 9090
    delay: 10
    timeout: 60

- name: Wait for Grafana to be ready
  wait_for:
    port: 3000
    delay: 10
    timeout: 60

- name: Display access information
  debug:
    msg: |
      Prometheus is running at: http://{{ ansible_host }}:9090
      Grafana is running at: http://{{ ansible_host }}:3000
      Default Grafana credentials - Username: admin, Password: admin
